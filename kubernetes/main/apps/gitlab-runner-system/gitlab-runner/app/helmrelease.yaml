---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab-runner
spec:
  interval: 30m
  chart:
    spec:
      chart: gitlab-runner
      version: 0.83.2
      sourceRef:
        kind: HelmRepository
        name: gitlab
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  valuesFrom:
    - targetPath: runnerToken
      kind: Secret
      name: gitlab-runner-secret
      valuesKey: runner-token
  values:
    # GitLab Runner configuration
    gitlabUrl: https://gitlab.lumu.au/  # Change this to your GitLab instance URL

    # Concurrent jobs
    concurrent: 3

    # Check interval
    checkInterval: 30

    # Runner configuration
    runners:
      config: |
        [[runners]]
          [runners.kubernetes]
            namespace = "{{.Release.Namespace}}"
            image = "ubuntu:22.04"
            privileged = true

            # Resource limits
            cpu_limit = "2"
            memory_limit = "2Gi"
            service_cpu_limit = "500m"
            service_memory_limit = "1Gi"
            helper_cpu_limit = "500m"
            helper_memory_limit = "512Mi"

            # Cache volumes for package managers
            [[runners.kubernetes.volumes.pvc]]
              name = "cache"
              mount_path = "/cache"
              read_only = false

            # Docker certs
            [[runners.kubernetes.volumes.empty_dir]]
              name = "docker-certs"
              mount_path = "/certs/client"
              medium = "Memory"

      # Runner tags
      tags: "kubernetes,docker,home-ops"

      # Run untagged jobs
      runUntagged: false

      # Lock to current project
      locked: false

      # Service account
      serviceAccountName: gitlab-runner

    # Service account for the runner pod
    rbac:
      create: false
      serviceAccountName: gitlab-runner

    # Pod resources
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

    # Security context
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      runAsNonRoot: true
      capabilities:
        drop: ["ALL"]

    # Pod security context
    podSecurityContext:
      runAsUser: 999
      fsGroup: 999

    # Volume mounts for runner state
    volumeMounts:
      - name: gitlab-runner-state
        mountPath: /.gitlab-runner

    volumes:
      - name: gitlab-runner-state
        emptyDir: {}
