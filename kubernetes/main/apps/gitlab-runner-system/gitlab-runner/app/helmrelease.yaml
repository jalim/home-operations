---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab-runner
spec:
  interval: 30m
  chart:
    spec:
      chart: gitlab-runner
      version: 0.83.2
      sourceRef:
        kind: HelmRepository
        name: gitlab
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  valuesFrom:
    - targetPath: runnerToken
      kind: Secret
      name: gitlab-runner-secret
      valuesKey: runner-token
  values:
    # GitLab Runner configuration
    gitlabUrl: https://gitlab.lumu.au/  # Change this to your GitLab instance URL

    # Number of runner replicas
    # Using 1 replica with higher concurrency is more resource-efficient than multiple replicas
    replicas: 1

    # Concurrent jobs - maximum jobs that can run simultaneously across all runners
    concurrent: 10

    # Check interval
    checkInterval: 30

    # Runner configuration
    runners:
      config: |
        concurrent = 10
        check_interval = 30
        [[runners]]
          limit = 10
          request_concurrency = 10
          [runners.kubernetes]
            namespace = "{{.Release.Namespace}}"
            image = "ubuntu:22.04"
            privileged = true

            # Resource limits and requests
            # Build container
            cpu_request = "250m"
            cpu_limit = "2"
            memory_request = "512Mi"
            memory_limit = "2Gi"

            # Service container (for services like docker:dind)
            service_cpu_request = "50m"
            service_cpu_limit = "500m"
            service_memory_request = "256Mi"
            service_memory_limit = "1Gi"

            # Helper container
            helper_cpu_request = "50m"
            helper_cpu_limit = "500m"
            helper_memory_request = "128Mi"
            helper_memory_limit = "512Mi"

            # Cache volumes for package managers
            [[runners.kubernetes.volumes.pvc]]
              name = "cache"
              mount_path = "/cache"
              read_only = false

            # Docker certs
            [[runners.kubernetes.volumes.empty_dir]]
              name = "docker-certs"
              mount_path = "/certs/client"
              medium = "Memory"

      # Runner tags
      tags: "kubernetes,docker,home-ops"

      # Run untagged jobs
      runUntagged: false

      # Lock to current project
      locked: false

      # Service account
      serviceAccountName: gitlab-runner

    # Service account for the runner pod
    rbac:
      create: false
      serviceAccountName: gitlab-runner

    # Pod resources for runner manager
    # Formula: CPU = 10m + (6m × concurrent), Memory = 50Mi + (2.5Mi × concurrent)
    # For 10 concurrent jobs: ~70m CPU, ~75Mi memory (with some headroom)
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 300m
        memory: 384Mi

    # Security context
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      runAsNonRoot: true
      capabilities:
        drop: ["ALL"]

    # Pod security context
    podSecurityContext:
      runAsUser: 999
      fsGroup: 999

    # Volume mounts for runner state
    volumeMounts:
      - name: gitlab-runner-state
        mountPath: /.gitlab-runner

    volumes:
      - name: gitlab-runner-state
        emptyDir: {}

    # Post-registration script to fix concurrent setting
    # This addresses GitLab issue #271 where concurrent doesn't merge properly
    preEntrypointScript: |
      #!/bin/bash
      # Update the concurrent setting in the final config after registration
      if [ -f "/.gitlab-runner/config.toml" ]; then
        sed -i 's/^concurrent = 1$/concurrent = 10/' /.gitlab-runner/config.toml
        echo "Updated concurrent setting to 10 in /.gitlab-runner/config.toml"
      fi
