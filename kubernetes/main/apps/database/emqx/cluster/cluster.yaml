---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/apps.emqx.io/emqx_v2beta1.json
apiVersion: apps.emqx.io/v2beta1
kind: EMQX
metadata:
  name: emqx5
  namespace: database
spec:
  image: public.ecr.aws/emqx/emqx:5.6.0
  config:
    data: |
      log.console.level = debug
      authentication = [{
        mechanism = password_based
        backend = postgresql
        enable = true

        password_hash_algorithm {
          name = bcrypt
        }

        database = emqx
        username = emqx
        password = ${EMQX_POSTGRES_PASS}
        server = "postgres16-rw.database.svc.cluster.local:5432"
        query = "SELECT password_hash, salt, is_superuser FROM users where username = ${username} LIMIT 1"
      }]

  coreTemplate:
    spec:
      replicas: 3
  dashboardServiceTemplate:
    spec:
      type: LoadBalancer
  listenersServiceTemplate:
    metadata:
      annotations:
        io.cilium/lb-ipam-ips: 10.88.0.36
    spec:
      type: LoadBalancer
