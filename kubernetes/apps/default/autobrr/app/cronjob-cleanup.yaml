---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: autobrr-cleanup
  namespace: default
spec:
  schedule: "0 2 * * 0"  # Every Sunday at 2 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: cleanup
            image: curlimages/curl:8.17.0@sha256:935d9100e9ba842cdb060de42472c7ca90cfe9a7c96e4dacb55e79e560b3ff40
            command:
            - sh
            - -c
            - |
              echo "Starting autobrr release cleanup..."
              echo "Deleting releases older than 168 hours (7 days)..."

              RESPONSE=$(curl -4 -w "\n%{http_code}" -s \
                --connect-timeout 10 \
                -X DELETE \
                "http://autobrr.default.svc.cluster.local/api/release?olderThan=168" \
                -H "X-API-Token: $AUTOBRR_API_KEY")

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              echo "HTTP Status: $HTTP_CODE"
              echo "Response: $BODY"

              if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                echo "✓ Cleanup successful!"
                exit 0
              else
                echo "✗ Cleanup failed with HTTP $HTTP_CODE"
                exit 1
              fi
            env:
            - name: AUTOBRR_API_KEY
              valueFrom:
                secretKeyRef:
                  name: autobrr-cleanup-secret
                  key: AUTOBRR__API_KEY
